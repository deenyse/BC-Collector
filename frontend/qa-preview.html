<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Q&A Preview - BC Collectors</title>
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
    </style>
    <script>
        window.API_BASE = '';
        
        // simple debug helper
        window.debug = function(event, data) {
            try { if (window.onDebug) window.onDebug(event, data); } catch (e) {}
            try { console.debug('[DEBUG]', event, data || ''); } catch (e) {}
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"]/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' })[c]);
        }
        
        // All Q&A listing, sorting, filtering
        let allQAs = [];
        let allFiles = [];

        async function fetchAllQAs() {
            const loadingMsg = document.getElementById('loadingMsg');
            const errorMsg = document.getElementById('errorMsg');
            
            loadingMsg.classList.remove('hidden');
            errorMsg.classList.add('hidden');
            
            try {
                window.debug('qaAll:list:start');
                const token = localStorage.getItem('auth_token');
                const headers = {};
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const resQ = await fetch(`${window.API_BASE}/api/qa`, { headers });
                if (!resQ.ok) throw new Error('Failed to fetch Q&A pairs');
                allQAs = await resQ.json();
                
                const resF = await fetch(`${window.API_BASE}/api/files`);
                if (!resF.ok) throw new Error('Failed to fetch files');
                allFiles = await resF.json();
                
                populateFileFilter();
                populateUserFilter();
                renderAllQAs();
                loadingMsg.classList.add('hidden');
                document.getElementById('qaCount').textContent = allQAs.length;
                window.debug('qaAll:list:done', { count: allQAs.length });
            } catch (err) {
                loadingMsg.classList.add('hidden');
                errorMsg.textContent = 'Error: ' + err.message;
                errorMsg.classList.remove('hidden');
                console.error('Error loading Q&A:', err);
                window.debug('qaAll:list:error', { message: err.message });
            }
        }

        function populateFileFilter() {
            const sel = document.getElementById('qaFileFilter');
            const cur = sel.value;
            sel.innerHTML = '<option value="">All files</option>';
            allFiles.forEach((f) => {
                const opt = document.createElement('option');
                opt.value = f._id;
                opt.textContent = f.filename;
                if (cur && cur === f._id) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function populateUserFilter() {
            const sel = document.getElementById('qaUserFilter');
            const cur = sel.value;
            // Get unique usernames from allQAs
            const usernames = new Set();
            allQAs.forEach((qa) => {
                const username = qa.createdBy && qa.createdBy.username ? qa.createdBy.username : '';
                if (username) usernames.add(username);
            });
            const sortedUsers = Array.from(usernames).sort();
            sel.innerHTML = '<option value="">All users</option>';
            sortedUsers.forEach((u) => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                if (cur && cur === u) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function renderAllQAs() {
            const tbody = document.getElementById('qaAllTable');
            const filterFileId = document.getElementById('qaFileFilter').value;
            const filterUsername = document.getElementById('qaUserFilter').value;
            const sortMode = document.getElementById('qaSort').value;
            let items = allQAs.slice();
            if (filterFileId) items = items.filter((q) => (q.fileId && (q.fileId._id || q.fileId) === filterFileId));
            if (filterUsername) items = items.filter((q) => {
                const username = q.createdBy && q.createdBy.username ? q.createdBy.username : '';
                return username === filterUsername;
            });
            // sort
            items.sort((a, b) => {
                if (sortMode === 'date_asc') return new Date(a.createdAt) - new Date(b.createdAt);
                if (sortMode === 'date_desc') return new Date(b.createdAt) - new Date(a.createdAt);
                const fa = (a.fileId && (a.fileId.filename || a.fileId)) || '';
                const fb = (b.fileId && (b.fileId.filename || b.fileId)) || '';
                if (sortMode === 'file_asc') return String(fa).localeCompare(String(fb));
                if (sortMode === 'file_desc') return String(fb).localeCompare(String(fa));
                return 0;
            });
            tbody.innerHTML = '';
            items.forEach((qa) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b align-top';
                const fileName = qa.fileId && qa.fileId.filename ? qa.fileId.filename : '-';
                const snippet = qa.textPiece.length > 100 ? qa.textPiece.slice(0, 100) + '…' : qa.textPiece;
                const added = qa.createdAt ? new Date(qa.createdAt).toLocaleString() : '';
                const creator = qa.createdBy && qa.createdBy.username ? qa.createdBy.username : '';
                tr.innerHTML = `
                    <td class="py-2 pr-4">${escapeHtml(fileName)}${creator ? ' · ' + escapeHtml(creator) : ''}</td>
                    <td class="py-2 pr-4">${escapeHtml(snippet)}</td>
                    <td class="py-2 pr-4">${escapeHtml(qa.question)}</td>
                    <td class="py-2 pr-4">${escapeHtml(qa.answer)}</td>
                    <td class="py-2 pr-4">${escapeHtml(added)}</td>
                `;
                tbody.appendChild(tr);
            });
            // files count (filtered): number of distinct files represented by items
            const distinct = new Set(items.map((q) => (q.fileId && (q.fileId._id || q.fileId)))).size;
            document.getElementById('qaFilesCount').textContent = String(distinct);
        }

        document.addEventListener('change', (e) => {
            if (e.target && e.target.id === 'qaFileFilter') {
                renderAllQAs();
            }
            if (e.target && e.target.id === 'qaUserFilter') {
                renderAllQAs();
            }
            if (e.target && e.target.id === 'qaSort') {
                renderAllQAs();
            }
        });

        // Download all Q&A pairs as JSON
        async function downloadQAsAsJSON() {
            window.debug('qa:download:start');
            try {
                const res = await fetch(`${window.API_BASE}/api/qa`);
                if (!res.ok) throw new Error('Failed to fetch Q&A pairs');
                const data = await res.json();
                
                // Format data with file and creator info
                const formatted = data.map((qa) => ({
                    id: qa._id,
                    fileId: qa.fileId?._id || qa.fileId,
                    fileName: qa.fileId?.filename || 'Unknown',
                    textPiece: qa.textPiece,
                    question: qa.question,
                    answer: qa.answer,
                    createdBy: qa.createdBy?.username || 'Unknown',
                    createdAt: qa.createdAt,
                }));
                
                const jsonStr = JSON.stringify(formatted, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const timestamp = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `qa-pairs-${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                window.debug('qa:download:done', { count: formatted.length });
            } catch (err) {
                window.debug('qa:download:error', { message: err.message });
                alert('Failed to download Q&A pairs: ' + err.message);
            }
        }
        
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const user = localStorage.getItem('auth_user');
            
            if (token && user) {
                try {
                    const u = JSON.parse(user);
                    document.getElementById('userInfo').textContent = `Signed in as ${u.username}`;
                } catch (e) {
                    console.error('Error parsing user info:', e);
                    document.getElementById('userInfo').textContent = 'Not signed in';
                }
            } else {
                document.getElementById('userInfo').textContent = 'Not signed in';
            }
        }
        
        // Initialize when DOM is ready
        function initialize() {
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('auth_user');
                window.location.href = '/';
            });
            
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = '/';
            });
            
            document.getElementById('downloadJsonBtn').addEventListener('click', downloadQAsAsJSON);
            
            checkAuth();
            fetchAllQAs();
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            // DOM is already loaded
            initialize();
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-4 space-y-4">
        <!-- Header -->
        <div class="bg-white p-4 rounded shadow flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button id="backBtn" class="px-3 py-1 border rounded hover:bg-gray-100 text-sm">← Back</button>
                <div>
                    <h1 class="text-xl font-semibold">Q&A Preview</h1>
                    <p class="text-sm text-gray-600">View all questions and answers</p>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span id="userInfo">Not signed in</span>
                <button id="logoutBtn" class="px-2 py-1 border rounded hover:bg-gray-100">Logout</button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="bg-white p-4 rounded shadow">
            <div class="flex items-center justify-between">
                <div>
                    <span class="text-sm text-gray-600">Total Q&A pairs: </span>
                    <span id="qaCount" class="font-semibold">0</span>
                </div>
                <button onclick="fetchAllQAs()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Refresh</button>
            </div>
        </div>
        
        <!-- Error Message -->
        <div id="errorMsg" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded"></div>
        
        <!-- Loading Message -->
        <div id="loadingMsg" class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded">
            Loading Q&A pairs...
        </div>
        
        <!-- All Q&A -->
        <div class="bg-white p-4 rounded shadow">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-2 mb-2">
                <h3 class="font-medium">All Q&A</h3>
                <div class="flex flex-wrap gap-2 items-end">
                    <button id="downloadJsonBtn" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">Download JSON</button>
                    <div>
                        <label for="qaFileFilter" class="text-sm text-gray-700">Filter by file</label>
                        <select id="qaFileFilter" class="border rounded p-1 ml-2">
                            <option value="">All files</option>
                        </select>
                    </div>
                    <div>
                        <label for="qaUserFilter" class="text-sm text-gray-700">Filter by user</label>
                        <select id="qaUserFilter" class="border rounded p-1 ml-2">
                            <option value="">All users</option>
                        </select>
                    </div>
                    <div>
                        <label for="qaSort" class="text-sm text-gray-700">Sort</label>
                        <select id="qaSort" class="border rounded p-1 ml-2">
                            <option value="date_desc">Date added (newest)</option>
                            <option value="date_asc">Date added (oldest)</option>
                            <option value="file_asc">File (A→Z)</option>
                            <option value="file_desc">File (Z→A)</option>
                        </select>
                    </div>
                    <div class="text-sm text-gray-600">Files: <span id="qaFilesCount">0</span></div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="text-left border-b">
                            <th class="py-2 pr-4">File</th>
                            <th class="py-2 pr-4">Snippet</th>
                            <th class="py-2 pr-4">Question</th>
                            <th class="py-2 pr-4">Answer</th>
                            <th class="py-2 pr-4">Added</th>
                        </tr>
                    </thead>
                    <tbody id="qaAllTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>

